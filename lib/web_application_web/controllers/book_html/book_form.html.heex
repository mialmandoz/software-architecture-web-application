<.form :let={f} for={@changeset} action={@action}>
  <div :if={@changeset.action} class="alert alert-danger">
    <p>Oops, something went wrong! Please check the errors below.</p>
  </div>

  <.input field={f[:name]} type="text" label="Name" />
  
<!-- Searchable Author Dropdown -->
  <div class="mb-4">
    <label class="block text-sm font-medium leading-6 text-zinc-900">Author</label>
    <div class="mt-2 relative">
      <input
        type="text"
        id="author-search"
        placeholder="Search for an author..."
        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
        autocomplete="off"
      />
      <div
        id="author-dropdown"
        class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto hidden"
      >
        <%= for author <- @authors do %>
          <div
            class="author-option px-3 py-2 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0"
            data-id={author.id}
            data-name={author.name}
          >
            {author.name}
          </div>
        <% end %>
      </div>
      <input
        type="hidden"
        name={f[:author_id].name}
        id={f[:author_id].id}
        value={f[:author_id].value}
      />
    </div>
  </div>

  <.input field={f[:summary]} type="textarea" label="Summary" />
  <.input field={f[:date_of_publication]} type="date" label="Date of publication" />
  <.input field={f[:number_of_sales]} type="number" label="Number of sales" />

  <div>
    <.button type="submit">Save Book</.button>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const searchInput = document.getElementById('author-search');
      const dropdown = document.getElementById('author-dropdown');
      const hiddenInput = document.querySelector('input[name="book[author_id]"]');
      const authorOptions = dropdown.querySelectorAll('.author-option');

      searchInput.addEventListener('focus', function() {
        dropdown.classList.remove('hidden');
      });

      searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        authorOptions.forEach(option => {
          const authorName = option.dataset.name.toLowerCase();
          if (authorName.includes(searchTerm)) {
            option.style.display = 'block';
          } else {
            option.style.display = 'none';
          }
        });
        dropdown.classList.remove('hidden');
      });

      authorOptions.forEach(option => {
        option.addEventListener('click', function() {
          searchInput.value = this.dataset.name;
          hiddenInput.value = this.dataset.id;
          dropdown.classList.add('hidden');
        });
      });

      document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
          dropdown.classList.add('hidden');
        }
      });
    });
  </script>
</.form>
